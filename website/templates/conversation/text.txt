import io
from flask import Blueprint, Response, render_template, request, session
from website.connections.openai_connection import OpenAIConnection
from website.connections.azure_conection import AzureConnection

views = Blueprint('views', __name__)
    
@views.route('/')
def home():
    return render_template("home.html")

@views.route('/newconversation', methods=['GET', 'POST'])
def new_conversation():
    if 'conversation' not in session:
        session['conversation'] = {}
        session['json'], session['final_json'] = OpenAIConnection.initialize()
        session['question'] = "What's your name?"

    conversation = session['conversation']
    json = session['json']
    final_json = session['final_json']
    question = session['question']

    if request.method == 'POST':
        answer = request.form['answer']
        print("POST request - Question before processing: ", question)

        conversation, json, final_json, question = OpenAIConnection.conversation(conversation, json, final_json, question, answer)

        print("Conversation state: ", conversation)
        print("POST request - Question after processing: ", question)

        session['conversation'] = conversation
        session['json'] = json
        session['final_json'] = final_json
        session['question'] = question
        
        if question == "Thanks for your time.":
            #paragraph = OpenAIConnection.create_paragraph(final_json)
            paragraph = "Hello my name is Sergio"
            audio_data = AzureConnection.text_to_speech(paragraph)
            if audio_data:
                return Response(io.BytesIO(audio_data), mimetype='audio/wav')

        return render_template('conversation/newconversation.html', conversation=conversation, question=question)
    else:
        session.pop('conversation', None)
        session.pop('json', None)
        session.pop('final_json', None)
        session.pop('question', None)
        question = "What's your name?"
        print("GET request - Initial Question: ", question)
        return render_template('conversation/newconversation.html', conversation={}, question=question)




        {% extends "base.html" %}
        {% block title %}Conversation{% endblock %}
        
        {% block content %}
        
        <style>
            #messageArea {
                display: flex;
                flex-direction: column-reverse;
                overflow-y: scroll;
                height: 500px;
                background-color: #f5f5f5;
                border: 1px solid #ccc;
                padding: 10px;
                border-radius: 10px;
            }
            .chat-message {
                margin-bottom: 15px;
                padding: 10px;
                border-radius: 10px;
                max-width: 75%;
                position: relative;
            }
            .question {
                background-color: #ffffff;
                align-self: flex-start;
                border: 1px solid #ddd;
            }
            .answer {
                background-color: #add8e6;
                align-self: flex-end;
                border: 1px solid #0056b3;
            }
            .input-group {
                margin-top: 15px;
                position: fixed;
                bottom: 20px;
                width: 100%;
                max-width: 800px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                background-color: #f5f5f5;
                border-radius: 25px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                padding: 5px;
            }
            .form-control {
                background-color: #f5f5f5;
                color: #333;
                border: none;
                border-radius: 25px 0 0 25px;
                padding: 10px 15px;
                flex-grow: 1;
                margin-right: 1px;
                margin-top: 5px;
            }
            .form-control:focus {
                background-color: #f5f5f5;
                outline: none;
                box-shadow: none;
            }
            .send-button {
                border: 2px solid #0056b3;
                padding: 10px 20px;
                border-radius: 0 25px 25px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                background-color: #add8e6;
                color: #0056b3;
            }
            .send-button:hover {
                background-color: #d0efff;
            }
            .send-button:focus {
                outline: none;
            }
            .restart-button {
                border: 2px solid #0056b3;
                padding: 10px 20px;
                border-radius: 25px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                background-color: #add8e6;
                color: #0056b3;
                margin: 20px auto;
                width: 150px;
                text-align: center;
                text-decoration: none;
            }
            .restart-button:hover {
                background-color: #d0efff;
                text-decoration: none;
            }
            .restart-button:focus {
                outline: none;
                text-decoration: none;
            }
        </style>
        
        
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <h2 class="text-center mb-4">Conversation</h2>
                    <div id="messageArea" class="mb-3">
                        {% if conversation %}
                            <div class="chat-message question">
                                {{ question }}<br>
                            </div>
                            {% for k, v in conversation.items()|reverse %}
                                <div class="chat-message answer">
                                    {{ v }}<br>
                                </div>
                                <div class="chat-message question">
                                    {{ k }}<br>
                                </div>
                            {% endfor %}
                        {% else %}  
                            <div class="chat-message question">
                                {{ question }}<br>
                            </div>
                        {% endif %}
                    </div>
                    {% if question != "Thanks for your time." %}
                        <form method="POST">
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    name="answer" 
                                    id="answer" 
                                    class="form-control" 
                                    placeholder="Type your answer here...">
                                <div class="input-group-append">
                                    <button 
                                        type="submit" 
                                        class="send-button">
                                        <strong>Send</strong>
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% else %}
                        <a 
                            class="restart-button" 
                            id="newConversation" 
                            href="/newconversation">
                            <strong>Restart</strong>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% endblock %}
        
